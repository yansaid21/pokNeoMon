<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pokemon DB 2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Pokemon DB2</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
                aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <!-- <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav me-auto mb-2 mb-md-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">List of Pokemon</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Parties</a>
                    </li>
                </ul>
            </div> -->
        </div>
    </nav>
    <main class="container" style="padding-top: 60px;">
        <div class="row">
            <div class="col-7">
                <div class="card">
                    <div class="card-body">
                        <form class="row g-2 align-items-center">
                            <div class="col-10">
                                <label class="visually-hidden" for="pk-search">Buscar</label>
                                <input type="text" class="form-control" id="pk-search" placeholder="Buscar">
                            </div>
                            <div class="col-2">
                                <button id="text-search-btn" type="submit" class="btn btn-primary">Buscar</button>
                            </div>
                        </form>
                        <form class="row g-2 align-items-center mt-2">
                            <div class="col">
                                <label class="visually-hidden" for="pk-name">Nombre</label>
                                <input type="text" class="form-control" id="pk-name" placeholder="Nombre">
                            </div>
                            <div class="col">
                                <label class="visually-hidden" for="pk-species">Especie</label>
                                <input type="text" class="form-control" id="pk-species" placeholder="Especie">
                            </div>
                            <div class="col">
                                <label class="visually-hidden" for="pk-desc">Descripci&oacute;n</label>
                                <input type="text" class="form-control" id="pk-desc" placeholder="Descripci&oacute;n">
                            </div>
                            <div class="col">
                                <label class="visually-hidden" for="pk-type">Tipo</label>
                                <input type="text" class="form-control" id="pk-type" placeholder="Tipo">
                                <!-- <select class="form-select" id="pk-type">
                                    <option selected>Tipo...</option>
                                    <option value="1">One</option>
                                    <option value="2">Two</option>
                                    <option value="3">Three</option>
                                </select> -->
                            </div>

                            <div class="col-3">
                                <button id="query-search-btn" type="submit" class="btn btn-primary">Buscar</button>
                            </div>
                        </form>
                    </div>
                    <div id="pokemon-list" class="row row-cols-3 g-0" style="max-height: 700px; overflow-y: scroll;">

                    </div>
                </div>
            </div>
            <div class="col-5">
                <h4>Busque y arrastre pokemon para conformar los equipos:</h4>
                <div class="row">
                    <div class="col-6">
                        <h5><strong>Player A:</strong> <input id="playerA" size="10" /></h5>
                        <div class="card">
                            <h5 class="card-header">Pokemon 1</h5>
                            <div id="teamA1-sel" class="teamA" data-team="teamA" data-pok="1" ondrop="drop(event)" ondragover="allowDrop(event)">
                                <!-- <img src="..." class="card-img-top" alt="..."> -->
                            </div>
                        </div>
                        <div class="card">
                            <h5 class="card-header">Pokemon 2</h5>
                            <div id="teamA2-sel" class="teamA" data-team="teamA" data-pok="2" ondrop="drop(event)" ondragover="allowDrop(event)">
                                <!-- <img src="..." class="card-img-top" alt="..."> -->
                            </div>
                        </div>
                        <div class="card">
                            <h5 class="card-header">Pokemon 3</h5>
                            <div id="teamA3-sel" class="teamA" data-team="teamA" data-pok="3" ondrop="drop(event)" ondragover="allowDrop(event)">
                                <!-- <img src="..." class="card-img-top" alt="..."> -->
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <h5><strong>Player B: </strong><input id="playerB" size="10" /></h5>
                        <div class="card">
                            <h5 class="card-header">Pokemon 1</h5>
                            <div id="teamB1-sel" class="teamB" data-team="teamB" data-pok="1" ondrop="drop(event)" ondragover="allowDrop(event)">
                                <!-- <img src="..." class="card-img-top" alt="..."> -->
                            </div>
                        </div>
                        <div class="card">
                            <h5 class="card-header">Pokemon 2</h5>
                            <div id="teamB2-sel" class="teamB" data-team="teamB" data-pok="2" ondrop="drop(event)" ondragover="allowDrop(event)">
                                <!-- <img src="..." class="card-img-top" alt="..."> -->
                            </div>
                        </div>
                        <div class="card">
                            <h5 class="card-header">Pokemon 3 <button id="strong-btn" class="btn btn-sm btn-primary" alt="Seleccionar fuerte contra A"><i class="bi-trophy"></i></button></h5>
                            <div id="teamB3-sel" class="teamB" data-team="teamB" data-pok="3" ondrop="drop(event)" ondragover="allowDrop(event)">
                                <!-- <img src="..." class="card-img-top" alt="..."> -->
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button id="simular-btn" class="btn btn-primary">Realizar Batalla</button>
                        <div id="winner-alert" class="alert alert-primary col-12 invisible" role="alert" style="margin-top: 0.5em;">
                            Winner: Player A
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="row">
            <!-- <button id="list-battle-btn" class="btn btn-success">List Battles</button> -->
            <table class="table table-bordered table-condensed">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Player A</th>
                        <th>Player B</th>
                        <th>Team A</th>
                        <th>Team B</th>
                        <th>Result</th>
                        <th>Winner</th>
                        <th></th>
                    </tr>
                    <tr>
                        <td><input id="battle-date" type="date" class="form-control"/></td>
                        <td><input id="battle-playerA" type="text" class="form-control" /></td>
                        <td><input id="battle-playerB" type="text" class="form-control" /></td>
                        <td></td>
                        <td></td>
                        <td></td>    
                        <td><input id="battle-winner" type="text" class="form-control" /></td>
                        <td><button id="filter-battle-btn" class="btn btn-warning">
                            <i class="bi-filter"></i>
                        </button></td>
                    </tr>
                </thead>
                <tbody id="battle-list">

                </tbody>
            </table>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
    <script src="pokemon-list.js"></script>
    <script src="crud-client.js"></script>
    <script>
        (async () => {
            console.log('Loading list of pokemon');
            const pokemon = await listPokemon(15);
            console.log(pokemon);
            showPokemonList(pokemon);
            document.addEventListener("click", async function (e) {
                const target = e.target.closest(".evo-btn");
                
                if (target) {
                    console.log(target);
                    const pid = target.dataset.pid;
                    const evolutions = await getEvolutions(pid);
                    target.parentElement.innerHTML = listEvolutions(evolutions);
                    // const pk = pokemon.find((p) => p.name == pname);
                }
            });
            document.getElementById("text-search-btn").addEventListener("click", function (e) {
                searchText();
                e.preventDefault();
                return false;
            });
            document.getElementById("query-search-btn").addEventListener("click", function (e) {
                searchObject();
                e.preventDefault();
                return false;
            });
            document.getElementById("strong-btn").addEventListener("click", async function (e) {
                e.preventDefault();
                if (teamA.includes("")) {
                    alert("Seleccione los pokemon del equipo A para buscar uno fuerte contra todos");
                    return;
                }
                const strong = await findStrongAgainst(teamA);
                selectPokemon(strong.id, "teamB", 3);
                return false;
            });
            document.getElementById("simular-btn").addEventListener("click", async function (e) {
                if (teamA.includes("") || teamB.includes("")) {
                    alert("Faltan pokemon por seleccionar");
                    return;
                }
                const playerA = document.getElementById('playerA').value;
                const playerB = document.getElementById('playerB').value;
                if (!playerA || !playerB) {
                    alert("Faltan nombres de jugadores");
                    return;
                }

                const battle = {
                    "date": new Date(),
                    "playerA": playerA,
                    "playerB": playerB,
                    "teamA": teamA, //ids de los pokemon del equipo A
                    "teamB": teamB, //ids de los pokemon del equipo A
                };
                const result = await simulateBattle(teamA, teamB);
                battle.resultado = result;
                bTotal = result.reduce((t, r) => t + r, 0);
                battle.winner = bTotal > 0 ? "A" : (bTotal < 1 ? "B" : "");
                showBattleResult(result);
                saveBattle(battle);
            });

            // document.getElementById('list-battle-btn').addEventListener("click", async function(e){
            //     const battles = await queryBattles({});
            //     document.getElementById('battle-list').innerHTML = listBattles(battles);
            // });

            document.getElementById('filter-battle-btn').addEventListener("click", async function(e){
                filterBattles();
            });
        })();

        async function searchText() {
            console.log("searching Text");
            const searchInput = document.getElementById('pk-search');
            const pokemon = await queryPokemon(searchInput.value);
            showPokemonList(pokemon);
        }

        async function searchObject() {
            console.log("searching objects");
            const searchName = document.getElementById('pk-name');
            const searchSpecies = document.getElementById('pk-species');
            const searchDesc = document.getElementById('pk-desc');
            const searchType = document.getElementById('pk-type');
            const query = {};
            if (searchName.value) query['name'] = searchName.value;
            if (searchSpecies.value) query['species'] = searchSpecies.value;
            if (searchDesc.value) query['description'] = searchDesc.value;
            if (searchType.value) query['types'] = searchType.value;
            const pokemon = await queryPokemon(query);
            showPokemonList(pokemon);
        }

        async function filterBattles() {
            const date = document.getElementById('battle-date');
            const pA = document.getElementById('battle-playerA');
            const pB = document.getElementById('battle-playerB');
            const winner = document.getElementById('battle-winner');
            const query = {};
            if (date.value) query['date'] = date.value;
            if (pA.value) query['playerA'] = pA.value;
            if (pB.value) query['playerB'] = pB.value;
            if (winner.value) query['winner'] = winner.value;
            const battles = await queryBattles(query);
            console.log("battles", battles);
            document.getElementById('battle-list').innerHTML = listBattles(battles);
        }

        function showPokemonList(pokemon) {
            showList(pokemon, document.getElementById("pokemon-list"));
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            const pid = ev.target.dataset['pid'];
            console.log('drag start ' + pid);
            ev.dataTransfer.setData("text", pid);
        }

        function drop(ev) {
            ev.preventDefault();
            var pid = ev.dataTransfer.getData("text");
            console.log('dropping');
            const team = ev.target.dataset['team'];
            const num = ev.target.dataset['pok'];
            console.log("team",team);
            console.log("num", num);
            selectPokemon(pid, team, num);
        }

        const WINNER_CL = 'text-bg-success';
        const LOSER_CL = 'text-bg-danger';
        const TIE_CL = 'text-bg-warning';

        function showBattleResult(result) {
            for (let i = 0; i < 3; i++) {
                const pA = document.getElementById('teamA' + (i + 1) + '-sel');
                const pB = document.getElementById('teamB' + (i + 1) + '-sel');
                pA.classList.remove(WINNER_CL);
                pA.classList.remove(LOSER_CL);
                pA.classList.remove(TIE_CL);
                
                pB.classList.remove(WINNER_CL);
                pB.classList.remove(LOSER_CL);
                pB.classList.remove(TIE_CL);
                
                pA.classList.add(result[i] == 1 ? WINNER_CL : (result[i] == -1 ? LOSER_CL : TIE_CL));
                pB.classList.add(result[i] == 1 ? LOSER_CL : (result[i] == -1 ? WINNER_CL : TIE_CL));
            }
        }

        async function selectPokemon(pid, team, num) {
            console.log("selecting pokemon");
            const pokemonList = await queryPokemon({id:pid});
            if (Array.isArray(pokemonList) && pokemonList.length > 0) {
                const p = pokemonList[0];
                const holder = document.getElementById(team + num + '-sel');
                console.log(holder);
                holder.innerHTML = `<img data-pname="${p.name}" src="${p.hires}" draggable="true" ondragstart="drag(event)" class="card-img-top rounded mx-auto d-block" style="width: 150px;" alt="${p.name}'s picture">`;
                if (team == 'teamA')
                    teamA[num - 1] = pid;
                else
                    teamB[num - 1] = pid;
            }
        }
        var teamA = ["","",""];
        var teamB = ["","",""];
    </script>
</body>

</html>